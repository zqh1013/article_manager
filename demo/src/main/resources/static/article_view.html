<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>查看文章 - 文章管理器</title>
    <script src="https://cdn.tailwindcss.com/3.3.3"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <style>
        body { font-family: 'Inter', 'Noto Sans SC', sans-serif; background-color: #f8fafc; }
        .article-body img { max-width: 100%; height: auto; border-radius: 0.375rem; margin-top: 1rem; margin-bottom: 1rem; }
        .article-body p { margin-bottom: 1rem; line-height: 1.75; }
        .article-body h1, .article-body h2, .article-body h3 { font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.75rem; }
        .article-body h1 { font-size: 1.875rem; }
        .article-body h2 { font-size: 1.5rem; }
        .article-body h3 { font-size: 1.25rem; }
        .comment-avatar { width: 40px; height: 40px; }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #6366f1;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">
<!-- 导航栏 -->
<nav class="bg-white shadow-sm sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
            <div class="flex items-center">
                <a href="javascript:returnHtml();" class="flex-shrink-0 flex items-center text-indigo-600 hover:text-indigo-700">
                    <i class="fas fa-arrow-left mr-3"></i>
                    <i class="fas fa-book-open text-2xl mr-2"></i>
                    <span class="text-xl font-semibold text-gray-800">文章管理器</span>
                </a>
            </div>
            <div class="flex items-center">
                <img class="h-8 w-8 rounded-full" src="https://randomuser.me/api/portraits/women/44.jpg" alt="用户头像">
            </div>
        </div>
    </div>
</nav>

<main class="max-w-4xl mx-auto p-6 space-y-8">
    <!-- 文章内容区域 -->
    <article class="bg-white rounded-lg shadow-xl overflow-hidden">
        <div id="articleHeader" class="p-6 md:p-8 border-b border-gray-200">
            <h1 id="articleTitleDisplay" class="text-3xl md:text-4xl font-bold text-gray-900 mb-3">加载中...</h1>
            <div class="text-sm text-gray-500 flex flex-wrap items-center gap-x-4 gap-y-1">
                <span><i class="fas fa-user mr-1.5"></i>作者: <span id="articleAuthor">未知</span></span>
                <span><i class="fas fa-calendar-alt mr-1.5"></i>发布于: <span id="articleDate">-</span></span>
                <span><i class="fas fa-folder-open mr-1.5"></i>分类: <span id="articleCategoryDisplay" class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full text-xs font-medium">未分类</span></span>
            </div>
        </div>

        <!-- AI摘要区域 -->
        <div id="aiSummarySection" class="p-6 md:p-8 bg-indigo-50 border-b border-indigo-200 hidden">
            <h3 class="text-lg font-semibold text-indigo-800 mb-2 flex items-center">
                <i class="fas fa-magic mr-2"></i> AI 生成摘要
            </h3>
            <p id="aiSummaryText" class="text-sm text-indigo-700 leading-relaxed">摘要加载中...</p>
        </div>

        <!-- 文章内容显示区域 -->
        <div id="articleBodyDisplay" class="p-6 md:p-8 prose prose-indigo max-w-none article-body">
            <div class="flex justify-center py-8" id="loadingIndicator">
                <div class="loading-spinner"></div>
                <p class="ml-4 text-gray-600">正在加载文章内容...</p>
            </div>
        </div>
    </article>

    <!-- 评论区 -->
    <section id="commentsSection" class="bg-white rounded-lg shadow-xl p-6 md:p-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">评论区 (<span id="commentCount">0</span>)</h2>

        <!-- 新评论表单 -->
        <div class="mb-8">
            <div class="flex items-start space-x-3">
                <img class="comment-avatar rounded-full" src="https://randomuser.me/api/portraits/women/44.jpg" alt="当前用户头像">
                <div class="flex-1">
                    <textarea id="newCommentText" rows="3" placeholder="写下你的评论..." class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm"></textarea>
                    <button onclick="postComment()" class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 text-sm font-medium flex items-center">
                        <i class="fas fa-paper-plane mr-2"></i>发表评论
                    </button>
                </div>
            </div>
        </div>

        <!-- 评论列表 -->
        <div id="commentsList" class="space-y-6">
            <!-- 评论将通过JavaScript动态加载 -->
        </div>
    </section>
</main>

<footer class="bg-white border-t border-gray-200 py-6 mt-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-500">
        © 2024 文章管理器. All rights reserved.
    </div>
</footer>

<script>
    // 从URL获取文章ID
    let email = null;
    let currentUserEmail = null;
    let articleId = null;
    function getArticleIdAndUserIdFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        email = urlParams.get('email') || null;
        currentUserEmail = email;
        articleId = urlParams.get('articleId') || null;
        return;
    }

    // 从后端获取文章数据
    async function fetchArticleData(articleId) {
        try {
            const response = await fetch(`/api/articles/article_view?email=${currentUserEmail}&articleId=${articleId}`);
            if (!response.ok) {
                throw new Error(`HTTP错误! 状态: ${response.status}`);
            }
            return await response.json();
        } catch (error) {
            console.error('获取文章数据失败:', error);
            return null;
        }
    }

    // 从后端获取评论数据
    async function fetchComments(articleId) {
        try {
            const response = await fetch(`/api/comments?articleId=${articleId}`);
            if (!response.ok) {
                throw new Error(`HTTP错误! 状态: ${response.status}`);
            }
            return await response.json();
        } catch (error) {
            console.error('获取评论失败:', error);
            return [];
        }
    }

    // 渲染文章内容
    function renderArticle(articleData) {
        if (!articleData) {
            document.getElementById('articleTitleDisplay').textContent = '文章加载失败';
            document.getElementById('articleBodyDisplay').innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-exclamation-triangle text-yellow-500 text-4xl mb-4"></i>
                        <p class="text-gray-700">无法加载文章内容，请稍后再试</p>
                        <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                            重新加载
                        </button>
                    </div>
                `;
            return;
        }

        // 更新文章标题
        document.getElementById('articleTitleDisplay').textContent = articleData.title;

        // 更新作者信息
        document.getElementById('articleAuthor').textContent = articleData.author || '未知作者';

        // 更新发布日期
        document.getElementById('articleDate').textContent = articleData.createTime;

        // 更新分类信息
        const categoryDisplay = document.getElementById('articleCategoryDisplay');
        if (articleData.categoryName) {
            categoryDisplay.textContent = articleData.categoryName;
            categoryDisplay.className = `px-2 py-0.5 rounded-full text-xs font-medium `;
        }

        // 更新AI摘要
        if (articleData.aiSummary) {
            document.getElementById('aiSummarySection').classList.remove('hidden');
            document.getElementById('aiSummaryText').textContent = articleData.aiSummary;
        }

        // 更新文章内容
        document.getElementById('articleBodyDisplay').innerHTML = articleData.content ||
            `<p class="text-gray-500 italic">本文暂无内容</p>`;
    }

    // 渲染评论
    function renderComments(comments) {
        const commentsList = document.getElementById('commentsList');
        commentsList.innerHTML = '';

        comments.forEach(comment => {
            const isCurrentUserComment = currentUserEmail && comment.email === currentUserEmail;

            const commentElement = document.createElement('div');
            commentElement.className = 'flex items-start space-x-3 comment-item';
            commentElement.dataset.commentId = comment.id; // 存储评论ID
            commentElement.dataset.commentEmail = comment.email; // 直接存储邮箱

            commentElement.innerHTML = `
            <img class="comment-avatar rounded-full" src="https://randomuser.me/api/portraits/lego/1.jpg" alt="评论者头像">
            <div class="flex-1">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="flex items-center justify-between mb-1">
                        <span class="font-semibold text-sm text-gray-800">${comment.author}</span>
                        <span class="text-xs text-gray-500">${comment.date}</span>
                    </div>
                    <p class="text-sm text-gray-700 leading-relaxed">${escapeHTML(comment.content)}</p>
                </div>
                <div class="mt-1 text-xs text-gray-500">
                    ${isCurrentUserComment ?
                `<button onclick="handleDeleteComment(${comment.id})" class="hover:text-red-600 font-medium">删除</button>` :
                `<span class="permission-error">仅评论作者可删除</span>`
            }
                </div>
            </div>
        `;
            commentsList.appendChild(commentElement);
        });

        updateCommentCount();
    }

    // 更新评论数量
    function updateCommentCount() {
        const count = document.querySelectorAll('#commentsList .comment-item').length;
        document.getElementById('commentCount').textContent = count;
    }

    // 发布评论
    async function postComment() {
        const commentText = document.getElementById('newCommentText').value.trim();
        if (!commentText) {
            alert('评论内容不能为空！');
            return;
        }
        try {
            response = await fetch(`/api/comments?email=${email}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    articleId: articleId,
                    content: commentText
                })
            });


            if (!response.ok) {
                throw new Error('评论发布失败');
            }

            const newComment = await response.json();
            document.getElementById('newCommentText').value = '';

            // 重新加载评论
            response = await fetchComments(articleId);
            comments =  response.data;
            renderComments(comments);

            alert('评论发表成功！');
        } catch (error) {
            console.error('发布评论失败:', error);
            alert('评论发布失败，请稍后再试');
        }
    }

    // 删除评论
    async function handleDeleteComment(commentId) {
        if (!confirm('确定删除这条评论吗？')) return;

        try {
            response = await fetch(`/api/comments/${commentId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                throw new Error('删除评论失败');
            }

            // 重新加载评论
            response = await fetchComments(articleId);
            comments =  response.data;
            renderComments(comments);

            alert('评论已删除');
        } catch (error) {
            console.error('删除评论失败:', error);
            alert('删除评论失败，请稍后再试');
        }
    }

    // HTML转义函数
    function escapeHTML(str) {
        return str.replace(/[&<>"']/g, function (match) {
            return {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[match];
        });
    }

    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', async () => {
        getArticleIdAndUserIdFromURL();
        if (!articleId) {
            renderArticle(null);
            return;
        }
        try {
            // 获取文章数据
            response = await fetchArticleData(articleId,email);
            articleData = response.data;
            renderArticle(articleData);
            // 获取评论数据
            response = await fetchComments(articleId);
            comments =  response.data;
            renderComments(comments);

            // 隐藏加载指示器
            document.getElementById('loadingIndicator').classList.add('hidden');
        } catch (error) {
            console.error('加载数据失败:', error);
            document.getElementById('loadingIndicator').innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-circle text-3xl mb-3"></i>
                        <p>数据加载失败</p>
                        <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                            重新加载
                        </button>
                    </div>
                `;
        }
    });

    function returnHtml(){
        window.location.href = `dashboard.html?email=${currentUserEmail}`;
    }
</script>
</body>
</html>